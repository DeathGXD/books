理解Kafka内部实现对在生产环境运行Kafka或者使用Kafka编写应用是非必要的。然而，知道Kafka工作原理在对Kafka进行故障排查或者尝试去理解Kafka的一些行为表现时提供了来龙去脉。由于涉及每个单独的实现细节和设计方案超出了本书的范围，在本章，我们将关注与Kafka使用者特别相关的三个主题：  
* Kafka备份原理
* Kafka如何处理生产者和消费者请求
* Kafka存储原理，比如文件格式和索引  

深入理解这三个主题对优化Kafka特别有用——理解这些机制的目的是可以长时间更好的使用Kafka，而不是随便摆弄它。  

### 集群成员  
Kafka使用Apache Zookeeper维护集群当前成员broker的列表。每个broker都有一个唯一标识，该标识要么在broker配置文件中进行配置，要么自动生成。每当一个broker进程启动，它会使用它的ID向Zookeeper注册一个临时的节点。Kafka的不同组件都会订阅Zookeeper中broker的注册路径/brokers/ids，这样当增加或者删除broker的时候它们就会获得通知。  

如果你尝试使用同一个ID去启动另一个broker，那么你将会获得一个错误——新的broker尝试去注册，但是失败了，因为我们已经拥有一个具有相同broker ID的Zookeeper节点。  

当一个broker失去了与Zookeeper的连接(通常是由于broker挂掉，但是由于网络分裂同样也可能引起这种情况，或者长时间垃圾收集阶段)，当broker启动时，broker创建的临时节点将会自动从Zookeeper中删除。Kafka中监视broker列表的组件将会收到broker挂掉的通知。  

即使当broker停掉了，代表broker的节点消失了，broker ID仍然存在在其他数据结构中。比如，每一个主题的副本列表，包含了副本的broker ID。这种情况下，如果你完全丢失了一个broker并启动了一个带有旧broker ID的崭新的broker，它将会立刻加入到集群，替换掉丢失的broker，并拥有相同的分区和主题。  

### 控制器  
控制器是Kafka broker其中之一，除了具备broker的通用功能外，它还负责选举分区的leader(我们将会在下一节中讨论分区leader和它主要做些什么)。集群中第一个启动的broker通过在Zookeeper中创建一个叫做/controller的临时节点进而成为控制器。当其他broker启动时，它们也同样会尝试创建这个节点，但是会收到一个"节点已经存在"的异常，这个将使那些broker意识到控制器节点已经存在，集群已经已经拥有了一个控制器。brokers会在控制器节点上创建一个Zookeeper的监视，进而当控制节点发生改变时，它们就会获得通知。通过这种方式，我们能够保证在同一时间集群中仅只有一个控制器。  

当控制器broker宕机或者与失去了与Zookeeper的连接，那么临时节点将会消失。集群中的其他broker通过Zookeeper的监视会获得控制器挂掉的通知，并且它们会自己尝试在Zookeeper中创建控制器节点。第一个在Zookeeper创建控制器节点的broker将会成为新的控制器，那么其他节点将会接受到"节点已经存在"的异常，并会重新在新的控制器节点上创建监视。每当一个新的控制器被选举出来，它都会通过Zookeeper的一个有条件的自增操作获得一个新的，更高的控制器版本号。broker都知道当前的控制器版本，如果它们从带有一个旧的版本号的控制器那里接受到一条消息，它们知道要忽略它。  

当控制器注意到一个broker离开了集群(通过监视相关的Zookeeper路径)，众所周知，在那个broker上的有一个leader分区的所有分区，都将需要一个新的leader。控制器会检查所有需要leader的分区，并决定哪个分区将成为新的leader(简单点就是之前的leader分区的副本列表中的下一个副本)，并发送请求给所有的要么包含新的leader，要么包含那些分区已存在的follower的broker。请求包含分区新的leader和follower的信息。每个新的leader明白需要重新开始服务生产者和消费者的客户端请求，并且follower也明白它们需要开始从新的leader上复制消息。  

当控制器注意到有broker加入到集群时，它会使用broker ID去检查那台broker是否存在副本。如果有，控制器会将相关改变通知给新的和已经存在的broker，并且新的broker上的副本将会从存在的leader上复制消息。  

简而言之，Kafka借用Zookeeper临时节点的特性来选择控制器，并当有新的节点加入到集群或者离开集群时通知控制器。当节点加入或者离开集群时，控制器负责在分区和副本中选择leader。控制器使用版本号，在两个节点都相信自己是控制器的时候，来防止"脑裂"的情况。  

### 副本  
副本是Kafka架构的核心。



### 请求处理  



#### 处理请求  



#### 拉取请求  




#### 其他请求  




### 物理存储  




#### 分区分配  






#### 文件管理  




#### 文件格式  




#### 索引  





#### 合并  





#### 合并机制  




#### 删除事件  




#### 主题合并时机
